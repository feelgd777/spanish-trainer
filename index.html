<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Spanish Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f5f5f5;
    }
    
    .options-group {
      margin-top: 0.75rem;
      padding-top: 0.25rem;
      border-top: 1px dashed #ddd;
    }

    .options-group-label {
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
      color: #555;
      font-weight: 500;
    }

    .app-container {
      max-width: 720px;
      margin: 0 auto;
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .controls label {
      font-size: 0.9rem;
      color: #444;
    }

    select {
      padding: 0.3rem 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
    }

    .question-box {
      margin-top: 0.5rem;
      padding: 1rem;
      border-radius: 10px;
      background: #fafafa;
      border: 1px solid #e0e0e0;
      min-height: 60px;
      white-space: pre-line;
    }

    .options {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .answer-btn {
      width: 100%;
      text-align: left;
      padding: 0.6rem 0.8rem;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s;
    }

    .answer-btn:hover {
      transform: translateY(-1px);
      background: #f0f0ff;
    }

    .answer-btn.correct {
      background: #d2f8d2;
      border-color: #37a937;
    }

    .answer-btn.wrong {
      background: #ffd7d7;
      border-color: #d93025;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      gap: 0.75rem;
    }

    #result {
      font-weight: 600;
      font-size: 0.95rem;
    }

    #explanation {
      margin-top: 0.6rem;
      font-size: 0.9rem;
      color: #555;
      white-space: pre-line;
    }

    #nextBtn {
      padding: 0.5rem 0.9rem;
      border-radius: 8px;
      border: none;
      background: #4f46e5;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
    }

    #nextBtn:hover {
      background: #4338ca;
    }

    @media (max-width: 600px) {
      body {
        padding: 0.75rem;
      }
      .app-container {
        padding: 1rem;
      }
      .controls {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <h1>Spanish Trainer</h1>

    <div class="controls">
      <div>
        <label for="modeSelect">Modo:</label><br />
        <select id="modeSelect">
          <option value="vocab">Vocabulario (ES ⇄ EN / RU)</option>
          <option value="prepositions">Preposiciones básicas</option>
          <option value="preposition_contrast">Preposiciones (contrastes)</option>
          <option value="verbs">Conjugaciones (presente)</option>
          <option value="gustar">Gustar / encantar / interesar</option>
          <option value="future">Planes futuros (ir a / pensar / tener planes de)</option>
          <option value="reflexive">Rutina diaria (verbos reflexivos)</option>
          <option value="context_vocab">Vocabulario en contexto</option>
        </select>
      </div>

      <div>
        <label for="directionSelect">Dirección (solo vocab):</label><br />
        <select id="directionSelect">
          <option value="es_en">ES → EN</option>
          <option value="en_es">EN → ES</option>
          <option value="es_ru">ES → RU</option>
          <option value="ru_es">RU → ES</option>
        </select>
      </div>
    </div>

    <div class="question-box" id="questionText">Cargando pregunta…</div>

    <div class="options" id="options"></div>

    <div class="status-row">
      <div id="result"></div>
      <button id="nextBtn">Siguiente</button>
    </div>

    <div id="explanation"></div>
  </div>

  <script>
    let currentQuestion = null;
    let lockedSingle = false;   // for single-blank questions
    let multiState = null;      // for multi-blank questions

    async function loadQuestion() {
      lockedSingle = false;
      multiState = null;

      const resultEl = document.getElementById("result");
      const explEl = document.getElementById("explanation");
      const questionEl = document.getElementById("questionText");
      const optionsEl = document.getElementById("options");

      resultEl.textContent = "";
      explEl.textContent = "";
      questionEl.textContent = "Cargando pregunta…";
      optionsEl.innerHTML = "";

      const mode = document.getElementById("modeSelect").value;
      const direction = document.getElementById("directionSelect").value;

      try {
        const res = await fetch(
          `/api/question?mode=${encodeURIComponent(mode)}&direction=${encodeURIComponent(direction)}`
        );
        const data = await res.json();
        currentQuestion = data;
        renderQuestion(data);
      } catch (err) {
        questionEl.textContent = "Error cargando la pregunta.";
        console.error(err);
      }
    }

    function renderQuestion(q) {
      const questionEl = document.getElementById("questionText");
      const optionsEl = document.getElementById("options");
      const resultEl = document.getElementById("result");
      const explEl = document.getElementById("explanation");

      resultEl.textContent = "";
      explEl.textContent = "";
      optionsEl.innerHTML = "";

      questionEl.textContent = q.question || "Pregunta sin texto.";

      // Multi-blank mode: presence of q.blanks (array)
      if (Array.isArray(q.blanks) && q.blanks.length > 0) {
        multiState = {
          answered: Array(q.blanks.length).fill(false)
        };

        q.blanks.forEach((blank, bIndex) => {
          const group = document.createElement("div");
          group.className = "options-group";

          const label = document.createElement("div");
          label.className = "options-group-label";
          label.textContent = `Hueco ${bIndex + 1}:`;
          group.appendChild(label);

          if (!blank.options || !blank.options.length) {
            const info = document.createElement("div");
            info.textContent = "No hay opciones disponibles.";
            group.appendChild(info);
          } else {
            blank.options.forEach((opt, idx) => {
              const btn = document.createElement("button");
              btn.className = "answer-btn";
              btn.textContent = opt;
              btn.addEventListener("click", () => handleAnswerMulti(bIndex, idx));
              group.appendChild(btn);
            });
          }

          optionsEl.appendChild(group);
        });

        return;
      }

      // Single-blank (or non-cloze) question: use flat options
      lockedSingle = false;

      if (!q.options || !q.options.length) {
        optionsEl.textContent = "No hay opciones disponibles.";
        return;
      }

      q.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "answer-btn";
        btn.textContent = opt;
        btn.addEventListener("click", () => handleAnswerSingle(idx));
        optionsEl.appendChild(btn);
      });
    }

    function handleAnswerSingle(index) {
      if (lockedSingle || !currentQuestion) return;
      lockedSingle = true;

      const correctIndex = currentQuestion.correct_index ?? 0;
      const optionsEls = document.querySelectorAll(".answer-btn");
      const resultEl = document.getElementById("result");
      const explEl = document.getElementById("explanation");

      optionsEls.forEach((btn, i) => {
        btn.disabled = true;
        if (i === correctIndex) {
          btn.classList.add("correct");
        }
        if (i === index && i !== correctIndex) {
          btn.classList.add("wrong");
        }
      });

      if (index === correctIndex) {
        resultEl.textContent = "✅ Correcto";
      } else {
        const correctText = currentQuestion.options[correctIndex];
        resultEl.textContent = `❌ Incorrecto. Correcto: ${correctText}`;
      }

      if (currentQuestion.explanation) {
        explEl.textContent = currentQuestion.explanation;
      } else {
        explEl.textContent = "";
      }
    }

    function handleAnswerMulti(blankIndex, optionIndex) {
      if (!currentQuestion || !Array.isArray(currentQuestion.blanks)) return;

      const blanks = currentQuestion.blanks;
      const resultEl = document.getElementById("result");
      const explEl = document.getElementById("explanation");

      const correctIndex = blanks[blankIndex].correct_index ?? 0;

      const groups = document.querySelectorAll(".options-group");
      const group = groups[blankIndex];
      const buttons = group.querySelectorAll(".answer-btn");

      // lock just this blank
      buttons.forEach((btn, i) => {
        btn.disabled = true;
        if (i === correctIndex) {
          btn.classList.add("correct");
        }
        if (i === optionIndex && i !== correctIndex) {
          btn.classList.add("wrong");
        }
      });

      if (optionIndex === correctIndex) {
        resultEl.textContent = `✅ Correcto en hueco ${blankIndex + 1}`;
      } else {
        const correctText = blanks[blankIndex].options[correctIndex];
        resultEl.textContent = `❌ Incorrecto en hueco ${blankIndex + 1}. Correcto: ${correctText}`;
      }

      if (currentQuestion.explanation) {
        explEl.textContent = currentQuestion.explanation;
      }

      // Mark this blank as answered
      if (multiState && Array.isArray(multiState.answered)) {
        multiState.answered[blankIndex] = true;
      }
    }

    document.getElementById("nextBtn").addEventListener("click", () => {
      loadQuestion();
    });

    document.getElementById("modeSelect").addEventListener("change", () => {
      loadQuestion();
    });

    document.getElementById("directionSelect").addEventListener("change", () => {
      const mode = document.getElementById("modeSelect").value;
      if (mode === "vocab") {
        loadQuestion();
      }
    });

    // Initial load
    loadQuestion();
  </script>


</body>
</html>
